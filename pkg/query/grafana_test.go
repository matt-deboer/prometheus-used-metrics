package query

import (
	"net/http"
	"net/http/httptest"
	"testing"

	log "github.com/sirupsen/logrus"
)

const apiSearch = `[{"id": 4,"title": "Applications","uri": "db/applications","type": "dash-db","tags": [],"isStarred": false  },  {"id": 10,"title": "Mesos","uri": "db/mesos","type": "dash-db","tags": [],"isStarred": false  },  {"id": 7,"title": "Resource Availability","uri": "db/resource-availability","type": "dash-db","tags": [],"isStarred": false}]`

const dashboardApplications = `{"meta":{"type":"db","canSave":false,"canEdit":false,"canStar":false,"slug":"applications","expires":"0001-01-01T00:00:00Z","created":"2017-08-14T21:40:31Z","updated":"2017-08-14T21:40:31Z","updatedBy":"admin","createdBy":"admin","version":0},"dashboard":{"annotations":{"list":[]},"editable":true,"gnetId":null,"graphTooltip":0,"hideControls":false,"id":18,"links":[],"refresh":"5s","rows":[{"collapse":false,"height":"250px","panels":[{"cacheTimeout":null,"colorBackground":false,"colorValue":false,"colors":["rgba(233, 205, 33, 0.9)","rgba(19, 164, 59, 0.89)","rgba(220, 109, 47, 0.97)"],"datasource":"mesos-prometheus","decimals":0,"editable":true,"error":false,"format":"percent","gauge":{"maxValue":150,"minValue":0,"show":true,"thresholdLabels":true,"thresholdMarkers":true},"id":6,"interval":null,"links":[],"mappingType":1,"mappingTypes":[{"name":"value to text","value":1},{"name":"range to text","value":2}],"maxDataPoints":100,"nullPointMode":"connected","nullText":null,"postfix":"","postfixFontSize":"50%","prefix":"","prefixFontSize":"50%","rangeMaps":[{"from":"null","text":"N/A","to":"null"}],"span":2,"sparkline":{"fillColor":"rgba(31, 118, 189, 0.18)","full":false,"lineColor":"rgb(31, 120, 193)","show":true},"targets":[{"expr":"avg(rate(container_cpu_user_seconds_total{marathon_app=\"$marathon_app\",id=~\"/docker.*\"}[1m]) / (container_spec_cpu_shares{marathon_app=\"$marathon_app\",id=~\"/docker.*\"} / 1024) * 100)","interval":"","intervalFactor":2,"legendFormat":"","refId":"A","step":600}],"thresholds":"50,100","title":"CPU Used vs. Reserved","type":"singlestat","valueFontSize":"70%","valueMaps":[{"op":"=","text":"N/A","value":"null"}],"valueName":"avg"},{"aliasColors":{},"bars":false,"datasource":"mesos-prometheus","decimals":2,"editable":true,"error":false,"fill":0,"grid":{},"id":5,"legend":{"alignAsTable":true,"avg":true,"current":true,"hideEmpty":true,"hideZero":true,"max":false,"min":false,"rightSide":true,"show":true,"sideWidth":100,"sort":"avg","sortDesc":false,"total":false,"values":true},"lines":true,"linewidth":2,"links":[],"nullPointMode":"connected","percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[{"alias":"[ reserved ]","color":"#614D93","fill":1,"linewidth":1}],"span":10,"stack":false,"steppedLine":false,"targets":[{"expr":"min(container_spec_cpu_shares{marathon_app=\"$marathon_app\",id=~\"/docker.*\"} / 1024)","interval":"","intervalFactor":2,"legendFormat":"[ reserved ]","refId":"B","step":60},{"expr":"rate(container_cpu_user_seconds_total{marathon_app=\"$marathon_app\"}[1m])","intervalFactor":2,"legendFormat":"{{ mesos_task }}","refId":"C","step":60}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"CPU Usage","tooltip":{"msResolution":true,"shared":false,"sort":0,"value_type":"cumulative"},"type":"graph","xaxis":{"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"none","label":"cores","logBase":1,"max":null,"min":null,"show":true},{"format":"short","label":"","logBase":1,"max":null,"min":null,"show":true}]}],"repeat":null,"repeatIteration":null,"repeatRowId":null,"showTitle":false,"title":"Row","titleSize":"h6"},{"collapse":false,"height":"250px","panels":[{"cacheTimeout":null,"colorBackground":false,"colorValue":false,"colors":["rgba(233, 205, 33, 0.9)","rgba(19, 164, 59, 0.89)","rgba(220, 109, 47, 0.97)"],"datasource":"mesos-prometheus","decimals":null,"editable":true,"error":false,"format":"percent","gauge":{"maxValue":100,"minValue":0,"show":true,"thresholdLabels":true,"thresholdMarkers":true},"id":7,"interval":null,"links":[],"mappingType":1,"mappingTypes":[{"name":"value to text","value":1},{"name":"range to text","value":2}],"maxDataPoints":100,"nullPointMode":"connected","nullText":null,"postfix":"","postfixFontSize":"50%","prefix":"","prefixFontSize":"50%","rangeMaps":[{"from":"null","text":"N/A","to":"null"}],"span":2,"sparkline":{"fillColor":"rgba(31, 118, 189, 0.18)","full":false,"lineColor":"rgb(31, 120, 193)","show":true},"targets":[{"expr":"sum(label_replace(container_memory_usage_bytes{marathon_app=\"$marathon_app\"}, \"app\", \"$0\", \"marathon_app\", \".*\" ) * 100) / sum(marathon_app_task_mem_in_mb{app=\"$marathon_app\"} * marathon_app_task_running{app=\"$marathon_app\"} * 1048576)","interval":"","intervalFactor":2,"legendFormat":"","refId":"A","step":600}],"thresholds":"30,80","title":"Memory Used vs. Reserved","type":"singlestat","valueFontSize":"70%","valueMaps":[{"op":"=","text":"N/A","value":"null"}],"valueName":"avg"},{"aliasColors":{},"bars":false,"datasource":"mesos-prometheus","decimals":2,"editable":true,"error":false,"fill":0,"grid":{},"id":4,"legend":{"alignAsTable":true,"avg":true,"current":true,"hideEmpty":true,"max":false,"min":false,"rightSide":true,"show":true,"total":false,"values":true},"lines":true,"linewidth":2,"links":[],"nullPointMode":"connected","percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[{"alias":"[ reserved ]","color":"#962D82","fill":1,"linewidth":1}],"span":10,"stack":false,"steppedLine":false,"targets":[{"expr":"min(marathon_app_task_mem_in_mb{app=\"$marathon_app\"} * 1048576)","interval":"","intervalFactor":2,"legendFormat":"[ reserved ]","refId":"B","step":60},{"expr":"sort_desc(sum(container_memory_usage_bytes{marathon_app=\"$marathon_app\"}) by (mesos_task))","intervalFactor":2,"legendFormat":"{{mesos_task}}","refId":"C","step":60}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"Memory Usage","tooltip":{"msResolution":true,"shared":false,"sort":0,"value_type":"cumulative"},"type":"graph","xaxis":{"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"bytes","label":null,"logBase":1,"max":null,"min":null,"show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}]}],"repeat":null,"repeatIteration":null,"repeatRowId":null,"showTitle":false,"title":"New row","titleSize":"h6"},{"collapse":false,"height":"250px","panels":[{"aliasColors":{},"bars":false,"datasource":"mesos-prometheus","editable":true,"error":false,"fill":2,"grid":{},"id":2,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":2,"links":[],"nullPointMode":"connected","percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[{"alias":"/.+/","color":"#65C5DB"}],"span":6,"stack":true,"steppedLine":false,"targets":[{"expr":"sort_desc(sum by (mesos_task, marathon_app) (rate(container_network_receive_bytes_total{marathon_app=\"$marathon_app\"}[1m])))","interval":"1m","intervalFactor":1,"legendFormat":"{{mesos_task}}","refId":"A","step":60}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"Network (Receive)","tooltip":{"msResolution":true,"shared":false,"sort":0,"value_type":"cumulative"},"type":"graph","xaxis":{"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"bytes","label":"bytes","logBase":1,"max":null,"min":null,"show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}]},{"aliasColors":{},"bars":false,"datasource":"mesos-prometheus","editable":true,"error":false,"fill":2,"grid":{},"id":3,"legend":{"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":2,"links":[],"nullPointMode":"connected","percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[{"alias":"/.+/","color":"#D683CE"}],"span":6,"stack":true,"steppedLine":false,"targets":[{"expr":"sort_desc(sum by (mesos_task, marathon_app) (rate(container_network_transmit_bytes_total{marathon_app=\"$marathon_app\"}[1m])))","interval":"10s","intervalFactor":1,"legendFormat":"{{mesos_task}}","refId":"A","step":10}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"Network Transfer","tooltip":{"msResolution":true,"shared":false,"sort":0,"value_type":"individual"},"type":"graph","xaxis":{"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"bytes","label":"bytes","logBase":1,"max":null,"min":null,"show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":true}]}],"repeat":null,"repeatIteration":null,"repeatRowId":null,"showTitle":false,"title":"New row","titleSize":"h6"}],"schemaVersion":14,"style":"dark","tags":[],"templating":{"list":[{"allValue":null,"current":{"text":"/ci/unisporkal-ahp-runners","value":"/ci/unisporkal-ahp-runners"},"datasource":"mesos-prometheus","hide":0,"includeAll":false,"label":"marathon_app","multi":false,"name":"marathon_app","options":[],"query":"container_last_seen{marathon_app=~\".+\"}","refresh":2,"regex":"/.*marathon_app=\\\"([^\"]+)\\\"/","sort":0,"tagValuesQuery":null,"tags":[],"tagsQuery":null,"type":"query","useTags":false}]},"time":{"from":"now-12h","to":"now"},"timepicker":{"refresh_intervals":["5s","10s","30s","1m","5m","15m","30m","1h","2h","1d"],"time_options":["5m","15m","1h","6h","12h","24h","2d","7d","30d"]},"timezone":"browser","title":"Applications","version":0}}`

const dashboardsMesos = `
{"meta":{"type":"db","canSave":false,"canEdit":false,"canStar":false,"slug":"mesos","expires":"0001-01-01T00:00:00Z","created":"2017-08-14T21:09:58Z","updated":"2017-08-14T21:09:58Z","updatedBy":"admin","createdBy":"admin","version":0},"dashboard":{"annotations":{"list":[]},"editable":true,"gnetId":null,"graphTooltip":0,"hideControls":false,"id":6,"links":[],"refresh":"1m","rows":[{"collapse":false,"height":237,"panels":[{"aliasColors":{},"bars":false,"datasource":"mesos-prometheus","editable":true,"error":false,"fill":2,"grid":{},"id":7,"legend":{"alignAsTable":false,"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":3,"links":[],"nullPointMode":"connected","percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[{"alias":"total","color":"#614D93"},{"alias":"used","color":"#AEA2E0"}],"span":3,"stack":false,"steppedLine":false,"targets":[{"expr":"sum(mesos_master_cpus)","interval":"","intervalFactor":2,"legendFormat":"total","refId":"A","step":4},{"expr":"sum(mesos_master_cpus{type=\"used\"})","interval":"","intervalFactor":2,"legendFormat":"used","refId":"B","step":4}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"Cluster CPU","tooltip":{"msResolution":true,"shared":false,"sort":0,"value_type":"cumulative"},"type":"graph","xaxis":{"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"short","label":null,"logBase":1,"max":null,"min":0,"show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":false}]},{"aliasColors":{},"bars":false,"datasource":"mesos-prometheus","editable":true,"error":false,"fill":2,"grid":{},"id":8,"legend":{"alignAsTable":false,"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":3,"links":[],"nullPointMode":"connected","percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[{"alias":"total","color":"#6D1F62"},{"alias":"used","color":"#BA43A9"}],"span":3,"stack":false,"steppedLine":false,"targets":[{"expr":"sum(mesos_master_mem)","interval":"","intervalFactor":2,"legendFormat":"total","refId":"A","step":4},{"expr":"sum(mesos_master_mem{type=\"used\"})","intervalFactor":2,"legendFormat":"used","refId":"B","step":4}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"Cluster Memory","tooltip":{"msResolution":true,"shared":false,"sort":0,"value_type":"cumulative"},"type":"graph","xaxis":{"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"mbytes","label":null,"logBase":1,"max":null,"min":0,"show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":false}]},{"aliasColors":{"registered":"#705DA0","unregistered":"#BF1B00"},"cacheTimeout":null,"combine":{"label":"all","threshold":"0"},"datasource":"mesos-prometheus","fontSize":"100%","format":"short","hideTimeOverride":false,"id":22,"interval":null,"legend":{"percentage":false,"show":true,"values":true},"legendType":"Right side","links":[],"maxDataPoints":3,"nullPointMode":"connected","pieType":"pie","span":3,"strokeWidth":1,"targets":[{"expr":"expected_total_agents - sum(mesos_master_slaves_state{registration_state=\"active\"})","interval":"","intervalFactor":2,"legendFormat":"unregistered","refId":"A","step":240},{"expr":"mesos_master_slaves_state{registration_state=\"active\"}","intervalFactor":2,"legendFormat":"registered","metric":"","refId":"B","step":240}],"timeFrom":"5m","title":"Agents","transparent":true,"type":"grafana-piechart-panel","valueName":"current"},{"aliasColors":{"10.251.135.97":"#508642","10.251.150.91":"#E5AC0E","10.251.150.92":"#2F575E","10.251.171.254":"#B7DBAB"},"bars":false,"datasource":"mesos-prometheus","editable":true,"error":false,"fill":2,"grid":{},"id":14,"legend":{"alignAsTable":false,"avg":false,"current":true,"max":false,"min":false,"show":true,"total":false,"values":true},"lines":true,"linewidth":3,"links":[],"nullPointMode":"connected","percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[],"span":3,"stack":false,"steppedLine":false,"targets":[{"expr":"(mesos_master_elected * mesos_master_uptime_seconds) \u003e 0","interval":"","intervalFactor":2,"legendFormat":"{{node_name}}","metric":"","refId":"A","step":4}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"Leader Uptime","tooltip":{"msResolution":true,"shared":false,"sort":0,"value_type":"cumulative"},"transparent":true,"type":"graph","xaxis":{"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"s","label":"","logBase":1024,"max":null,"min":0,"show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":false}]}],"repeat":null,"repeatIteration":null,"repeatRowId":null,"showTitle":false,"title":"Row","titleSize":"h6"},{"collapse":false,"height":"250px","panels":[{"chartId":"chart_15","colors":["rgb(190, 153, 234)","rgb(123, 81, 209)","rgb(77, 8, 175)"],"datasource":"mesos-prometheus","editable":true,"error":false,"format":"none","id":15,"legend":{"avg":true,"current":true,"max":true,"min":true,"show":false,"total":true},"links":[],"mappingType":1,"maxDataPoints":100,"nullPointMode":"connected","seriesOverrides":[],"span":6,"targets":[{"expr":"sum(marathon_app_task_cpus * marathon_app_task_running) by (app)","interval":"","intervalFactor":2,"legendFormat":"{{app}}","refId":"A","step":20}],"thresholds":"0,5,10,20","title":"CPU by App","transparent":true,"treeMap":{"colorByFunction":"current","debug":false,"depth":0,"enableGrouping":true,"enableTimeBlocks":false,"groups":[{"key":"server","value":"/^.*./g"}],"ids":["alias"],"mode":"squarify","nodeSizeProperty":"value","showLegend":false,"sizeByFunction":"current"},"type":"savantly-heatmap-panel","valueMaps":[{"op":"=","text":"N/A","value":"null"}]},{"chartId":"chart_16","colors":["rgb(241, 172, 195)","rgb(209, 81, 146)","rgb(176, 0, 118)"],"datasource":"mesos-prometheus","editable":true,"error":false,"format":"none","id":16,"legend":{"avg":true,"current":true,"max":true,"min":true,"show":false,"total":true},"links":[],"mappingType":1,"maxDataPoints":100,"nullPointMode":"connected","seriesOverrides":[],"span":6,"targets":[{"expr":"sum(marathon_app_task_mem_in_mb * marathon_app_task_running) by (app)","interval":"","intervalFactor":2,"legendFormat":"{{app}}","refId":"A","step":20}],"thresholds":"0,15000,30000","title":"Memory by App","transparent":true,"treeMap":{"colorByFunction":"current","debug":false,"depth":0,"enableGrouping":true,"enableTimeBlocks":false,"groups":[{"key":"server","value":"/^.*./g"}],"ids":["alias"],"mode":"squarify","nodeSizeProperty":"value","showLegend":false,"sizeByFunction":"current"},"type":"savantly-heatmap-panel","valueMaps":[{"op":"=","text":"N/A","value":"null"}]}],"repeat":null,"repeatIteration":null,"repeatRowId":null,"showTitle":false,"title":"New row","titleSize":"h6"},{"collapse":false,"height":"200px","panels":[{"columns":[{"text":"Current","value":"current"}],"datasource":"mesos-prometheus","editable":true,"error":false,"fontSize":"100%","id":12,"links":[],"pageSize":null,"scroll":true,"showHeader":true,"sort":{"col":1,"desc":true},"span":2,"styles":[{"dateFormat":"YYYY-MM-DD HH:mm:ss","pattern":"Time","type":"number"},{"colorMode":"row","colors":["rgba(114, 212, 110, 0)","rgba(237, 141, 40, 0.77)","rgba(245, 54, 54, 0.9)"],"decimals":1,"pattern":"Current","thresholds":["65","90"],"type":"number","unit":"percent"}],"targets":[{"expr":"((node_filesystem_size{mountpoint=\"/rootfs\",mesos_role=\"master\"} - node_filesystem_free{mountpoint=\"/rootfs\",mesos_role=\"master\"}) / node_filesystem_size{mountpoint=\"/rootfs\",mesos_role=\"master\"}) * 100","interval":"","intervalFactor":2,"legendFormat":"{{node_name}}","refId":"A","step":4}],"title":"Master Disk Used: /","transform":"timeseries_aggregations","type":"table"},{"columns":[{"text":"Current","value":"current"}],"datasource":"mesos-prometheus","editable":true,"error":false,"fontSize":"100%","id":11,"links":[],"pageSize":null,"scroll":true,"showHeader":true,"sort":{"col":1,"desc":true},"span":2,"styles":[{"dateFormat":"YYYY-MM-DD HH:mm:ss","pattern":"Time","type":"number"},{"colorMode":"row","colors":["rgba(114, 212, 110, 0)","rgba(237, 141, 40, 0.77)","rgba(245, 54, 54, 0.9)"],"decimals":1,"pattern":"Current","thresholds":["50","80"],"type":"number","unit":"percent"}],"targets":[{"expr":"((node_filesystem_size{mountpoint=\"/rootfs/var/lib\",mesos_role=\"master\"} - node_filesystem_free{mountpoint=\"/rootfs/var/lib\",mesos_role=\"master\"}) / node_filesystem_size{mountpoint=\"/rootfs/var/lib\",mesos_role=\"master\"}) * 100","interval":"","intervalFactor":2,"legendFormat":"{{node_name}}","refId":"A","step":4}],"title":"Master Disk Used: /var/lib","transform":"timeseries_aggregations","type":"table"},{"columns":[{"text":"Current","value":"current"}],"datasource":"mesos-prometheus","editable":true,"error":false,"fontSize":"100%","id":10,"links":[],"pageSize":null,"scroll":true,"showHeader":true,"sort":{"col":1,"desc":true},"span":2,"styles":[{"dateFormat":"YYYY-MM-DD HH:mm:ss","pattern":"Time","type":"number"},{"colorMode":"row","colors":["rgba(114, 212, 110, 0)","rgba(237, 141, 40, 0.77)","rgba(245, 54, 54, 0.9)"],"decimals":1,"pattern":"Current","thresholds":["65","90"],"type":"number","unit":"percent"}],"targets":[{"expr":"((node_filesystem_size{mountpoint=\"/rootfs\",mesos_role=\"agent\"} - node_filesystem_free{mountpoint=\"/rootfs\",mesos_role=\"agent\"}) / node_filesystem_size{mountpoint=\"/rootfs\",mesos_role=\"agent\"}) * 100","interval":"","intervalFactor":2,"legendFormat":"{{node_name}}","refId":"A","step":4}],"title":"Agent Disk Used: /","transform":"timeseries_aggregations","type":"table"},{"columns":[{"text":"Current","value":"current"}],"datasource":"mesos-prometheus","editable":true,"error":false,"fontSize":"100%","id":9,"links":[],"pageSize":null,"scroll":true,"showHeader":true,"sort":{"col":1,"desc":true},"span":2,"styles":[{"dateFormat":"YYYY-MM-DD HH:mm:ss","pattern":"Time","type":"number"},{"colorMode":"row","colors":["rgba(114, 212, 110, 0)","rgba(237, 141, 40, 0.77)","rgba(245, 54, 54, 0.9)"],"decimals":1,"pattern":"Current","thresholds":["50","80"],"type":"number","unit":"percent"}],"targets":[{"expr":"((node_filesystem_size{mountpoint=\"/rootfs/var/lib\",mesos_role=\"agent\"} - node_filesystem_free{mountpoint=\"/rootfs/var/lib\",mesos_role=\"agent\"}) / node_filesystem_size{mountpoint=\"/rootfs/var/lib\",mesos_role=\"agent\"}) * 100","interval":"","intervalFactor":2,"legendFormat":"{{node_name}}","refId":"A","step":4}],"title":"Agent Disk Used: /var/lib","transform":"timeseries_aggregations","type":"table"},{"aliasColors":{},"bars":false,"datasource":"mesos-prometheus","editable":true,"error":false,"fill":2,"grid":{},"id":13,"legend":{"alignAsTable":false,"avg":false,"current":false,"max":false,"min":false,"show":true,"total":false,"values":false},"lines":true,"linewidth":3,"links":[],"nullPointMode":"connected","percentage":false,"pointradius":5,"points":false,"renderer":"flot","seriesOverrides":[{"alias":"total","color":"#1F78C1"},{"alias":"used","color":"#EAB839"}],"span":4,"stack":false,"steppedLine":false,"targets":[{"expr":"sum(node_filesystem_size{mountpoint=\"/rootfs/var/lib\",mesos_role=\"agent\"})","interval":"","intervalFactor":2,"legendFormat":"total","refId":"A","step":2},{"expr":"sum(node_filesystem_size{mountpoint=\"/rootfs/var/lib\",mesos_role=\"agent\"} - node_filesystem_free{mountpoint=\"/rootfs/var/lib\",mesos_role=\"agent\"})","intervalFactor":2,"legendFormat":"used","refId":"B","step":2}],"thresholds":[],"timeFrom":null,"timeShift":null,"title":"Mesos Cluster Disk (Aggregate Agent /var/lib )","tooltip":{"msResolution":true,"shared":false,"sort":0,"value_type":"cumulative"},"type":"graph","xaxis":{"mode":"time","name":null,"show":true,"values":[]},"yaxes":[{"format":"bytes","label":null,"logBase":1,"max":null,"min":0,"show":true},{"format":"short","label":null,"logBase":1,"max":null,"min":null,"show":false}]}],"repeat":null,"repeatIteration":null,"repeatRowId":null,"showTitle":false,"title":"New row","titleSize":"h6"},{"collapse":false,"height":"250px","panels":[{"columns":[{"text":"Avg","value":"avg"}],"datasource":"mesos-prometheus","editable":true,"error":false,"fontSize":"90%","id":17,"links":[],"pageSize":null,"scroll":true,"showHeader":true,"sort":{"col":null,"desc":false},"span":3,"styles":[{"dateFormat":"YYYY-MM-DD HH:mm:ss","pattern":"Time","type":"date"},{"colorMode":null,"colors":["rgba(245, 54, 54, 0.9)","rgba(237, 129, 40, 0.89)","rgba(50, 172, 45, 0.97)"],"decimals":2,"pattern":"/.*/","thresholds":[],"type":"number","unit":"short"}],"targets":[{"expr":"sort_desc( avg by (marathon_app) (rate(container_cpu_user_seconds_total{marathon_app=~\".+\",id=~\"/docker.*\"}[5m]) * 100 / (container_spec_cpu_shares{marathon_app=~\".+\",id=~\"/docker.*\"} \u003e 50/ 1024)) \u003c 50)","interval":"","intervalFactor":2,"legendFormat":"{{marathon_app}}","refId":"A","step":4}],"title":"Overprovisioned CPU ( needs less ! )","transform":"timeseries_aggregations","type":"table"},{"columns":[{"text":"Avg","value":"avg"}],"datasource":"mesos-prometheus","editable":true,"error":false,"fontSize":"90%","id":18,"links":[],"pageSize":null,"scroll":true,"showHeader":true,"sort":{"col":1,"desc":true},"span":3,"styles":[{"dateFormat":"YYYY-MM-DD HH:mm:ss","pattern":"Time","type":"date"},{"colorMode":null,"colors":["rgba(245, 54, 54, 0.9)","rgba(237, 129, 40, 0.89)","rgba(50, 172, 45, 0.97)"],"decimals":2,"pattern":"/.*/","thresholds":[],"type":"number","unit":"short"}],"targets":[{"expr":"avg by (marathon_app) (rate(container_cpu_user_seconds_total{marathon_app=~\".+\",id=~\"/docker.*\"}[5m]) * 100 / (container_spec_cpu_shares{marathon_app=~\".+\",id=~\"/docker.*\"}/ 1024)) \u003e 100","interval":"","intervalFactor":2,"legendFormat":"{{marathon_app}}","refId":"A","step":4}],"title":"Underprovisioned CPU ( needs more ! )","transform":"timeseries_aggregations","type":"table"},{"columns":[{"text":"Avg","value":"avg"}],"datasource":"mesos-prometheus","editable":true,"error":false,"fontSize":"90%","id":19,"links":[],"pageSize":null,"scroll":true,"showHeader":true,"sort":{"col":1,"desc":false},"span":3,"styles":[{"dateFormat":"YYYY-MM-DD HH:mm:ss","pattern":"Time","type":"date"},{"colorMode":null,"colors":["rgba(247, 70, 70, 0.9)","rgba(237, 129, 40, 0.89)","rgba(3, 3, 3, 0)"],"decimals":2,"pattern":"/.*/","thresholds":["5"," 10"],"type":"number","unit":"short"}],"targets":[{"expr":"sum(label_replace(container_memory_working_set_bytes{marathon_app=~\".+\"}, \"app\", \"$0\", \"marathon_app\", \".*\" ) * 100) by (app)/ sum(marathon_app_task_mem_in_mb * marathon_app_task_running * 1048576) by (app) \u003c 30","interval":"","intervalFactor":2,"legendFormat":"{{app}}","refId":"A","step":4}],"title":"Overprovisioned Memory ( needs less ! )","transform":"timeseries_aggregations","type":"table"},{"columns":[{"text":"Avg","value":"avg"}],"datasource":"mesos-prometheus","editable":true,"error":false,"fontSize":"90%","id":20,"links":[],"pageSize":null,"scroll":true,"showHeader":true,"sort":{"col":1,"desc":true},"span":3,"styles":[{"dateFormat":"YYYY-MM-DD HH:mm:ss","pattern":"Time","type":"date"},{"colorMode":null,"colors":["rgba(247, 70, 70, 0.9)","rgba(237, 129, 40, 0.89)","rgba(3, 3, 3, 0)"],"decimals":2,"pattern":"/.*/","thresholds":["5"," 10"],"type":"number","unit":"short"}],"targets":[{"expr":"sum(label_replace(container_memory_working_set_bytes{marathon_app=~\".+\"}, \"app\", \"$0\", \"marathon_app\", \".*\" ) * 100) by (app)/ sum(marathon_app_task_mem_in_mb * (marathon_app_task_running \u003e 0) * 1048576) by (app) \u003e 80","interval":"","intervalFactor":2,"legendFormat":"{{app}}","refId":"A","step":4}],"title":"Underprovisioned Memory ( needs more ! )","transform":"timeseries_aggregations","type":"table"}],"repeat":null,"repeatIteration":null,"repeatRowId":null,"showTitle":false,"title":"New row","titleSize":"h6"}],"schemaVersion":14,"style":"dark","tags":[],"templating":{"list":[]},"time":{"from":"now-15m","to":"now"},"timepicker":{"collapse":false,"enable":true,"notice":false,"now":true,"refresh_intervals":["5s","10s","30s","1m","5m","15m","30m","1h","2h","1d"],"status":"Stable","time_options":["5m","15m","1h","2h","6h","12h","1d","7d"],"type":"timepicker"},"timezone":"browser","title":"Mesos","version":0}}`

const dashboardResourceAvailability = `{"meta":{"type":"db","canSave":false,"canEdit":false,"canStar":false,"slug":"resource-availability","expires":"0001-01-01T00:00:00Z","created":"2017-08-14T21:09:58Z","updated":"2017-08-14T21:09:58Z","updatedBy":"admin","createdBy":"admin","version":0},"dashboard":{"annotations":{"list":[]},"editable":true,"gnetId":null,"graphTooltip":0,"hideControls":false,"id":9,"links":[],"rows":[{"collapse":false,"height":250,"panels":[{"columns":[{"text":"Max","value":"max"}],"datasource":"mesos-prometheus","filterNull":false,"fontSize":"100%","hideTimeOverride":true,"id":1,"links":[],"pageSize":null,"scroll":true,"showHeader":true,"sort":{"col":0,"desc":true},"span":6,"styles":[{"dateFormat":"YYYY-MM-DD HH:mm:ss","pattern":"Time","type":"date"},{"colorMode":null,"colors":["rgba(245, 54, 54, 0.9)","rgba(237, 129, 40, 0.89)","rgba(50, 172, 45, 0.97)"],"decimals":0,"pattern":"/.*/","thresholds":[],"type":"number","unit":"short"}],"targets":[{"expr":"count(max(label_replace(agent_attributes{cloud=\"vmware\"}, \"node_name\", \"$0\", \"exported_node_name\", \".*\") and on(node_name) (mesos_slave_cpus{type=\"free\",ingress=\"\"} \u003e= $cpu and mesos_slave_mem{type=\"free\"} \u003e= $mem)) by (node_name, rack)) by (rack)","interval":"","intervalFactor":2,"legendFormat":"{{rack}}","refId":"A","step":2}],"timeFrom":"1m","timeShift":null,"title":"VMWare Agents by rack","transform":"timeseries_aggregations","type":"table"},{"columns":[{"text":"Max","value":"max"}],"datasource":"mesos-prometheus","filterNull":false,"fontSize":"100%","hideTimeOverride":true,"id":2,"links":[],"pageSize":null,"scroll":true,"showHeader":true,"sort":{"col":0,"desc":true},"span":6,"styles":[{"dateFormat":"YYYY-MM-DD HH:mm:ss","pattern":"Time","type":"date"},{"colorMode":null,"colors":["rgba(245, 54, 54, 0.9)","rgba(237, 129, 40, 0.89)","rgba(50, 172, 45, 0.97)"],"decimals":0,"pattern":"/.*/","thresholds":[],"type":"number","unit":"short"}],"targets":[{"expr":"count(max(label_replace(agent_attributes{cloud=\"aws\"}, \"node_name\", \"$0\", \"exported_node_name\", \".*\") and on(node_name) (mesos_slave_cpus{type=\"free\",ingress=\"\"} \u003e= $cpu and mesos_slave_mem{type=\"free\"} \u003e= $mem)) by (node_name, az)) by (az)","interval":"","intervalFactor":2,"legendFormat":"{{az}}","refId":"A","step":2}],"timeFrom":"1m","timeShift":null,"title":"AWS Agents by az","transform":"timeseries_aggregations","type":"table"}],"repeat":null,"repeatIteration":null,"repeatRowId":null,"showTitle":false,"title":"Dashboard Row","titleSize":"h6"}],"schemaVersion":14,"style":"dark","tags":[],"templating":{"list":[{"allValue":null,"current":{"tags":[],"text":"0.5","value":"0.5"},"hide":0,"includeAll":false,"label":"CPU (in cores)","multi":false,"name":"cpu","options":[{"selected":true,"text":"0.5","value":"0.5"},{"selected":false,"text":"1","value":"1"},{"selected":false,"text":"1.5","value":"1.5"},{"selected":false,"text":"2","value":"2"},{"selected":false,"text":"3","value":"3"},{"selected":false,"text":"4","value":"4"},{"selected":false,"text":"6","value":"6"},{"selected":false,"text":"8","value":"8"},{"selected":false,"text":"10","value":"10"}],"query":"0.5,1,1.5,2,3,4,6,8,10","type":"custom"},{"allValue":null,"current":{"text":"512","value":"512"},"hide":0,"includeAll":false,"label":"Memory (in MB)","multi":false,"name":"mem","options":[{"selected":true,"text":"512","value":"512"},{"selected":false,"text":"768","value":"768"},{"selected":false,"text":"1024","value":"1024"},{"selected":false,"text":"1536","value":"1536"},{"selected":false,"text":"2048","value":"2048"},{"selected":false,"text":"4096","value":"4096"},{"selected":false,"text":"6144","value":"6144"},{"selected":false,"text":"8192","value":"8192"},{"selected":false,"text":"10240","value":"10240"},{"selected":false,"text":"12288","value":"12288"},{"selected":false,"text":"14336","value":"14336"},{"selected":false,"text":"16384","value":"16384"},{"selected":false,"text":"18432","value":"18432"},{"selected":false,"text":"20480","value":"20480"},{"selected":false,"text":"22528","value":"22528"},{"selected":false,"text":"24576","value":"24576"},{"selected":false,"text":"26624","value":"26624"},{"selected":false,"text":"28672","value":"28672"},{"selected":false,"text":"30720","value":"30720"},{"selected":false,"text":"32768","value":"32768"}],"query":"512,768,1024,1536,2048,4096,6144,8192,10240,12288,14336,16384,18432,20480,22528,24576,26624,28672,30720,32768","type":"custom"}]},"time":{"from":"now-6h","to":"now"},"timepicker":{"refresh_intervals":["5s","10s","30s","1m","5m","15m","30m","1h","2h","1d"],"time_options":["5m","15m","1h","6h","12h","24h","2d","7d","30d"]},"timezone":"browser","title":"Resource Availability","version":0}}`

type mockGrafana struct {
}

func (mp *mockGrafana) ServeHTTP(w http.ResponseWriter, r *http.Request) {

	if r.URL.Path == "/api/search" {
		w.Write([]byte(apiSearch))
	} else if r.URL.Path == "/api/dashboards/db/applications" {
		w.Write([]byte(dashboardApplications))
	} else if r.URL.Path == "/api/dashboards/db/resource-availability" {
		w.Write([]byte(dashboardResourceAvailability))
	} else if r.URL.Path == "/api/dashboards/db/mesos" {
		w.Write([]byte(dashboardsMesos))
	} else {
		http.Error(w, "Bad Gateway", http.StatusBadGateway)
	}

}

func TestGetMetricUsage(t *testing.T) {

	graf1 := &mockGrafana{}
	graf1Server := httptest.NewServer(graf1)
	defer graf1Server.Close()

	gr := NewGrafanaDashboardsResolver(graf1Server.URL, "fakeApiKey")

	log.SetLevel(log.DebugLevel)

	usage, err := gr.GetMetricUsage()
	if err != nil {
		t.Error(err)
	}

	if usage == nil {
		t.Errorf("Expected usage metrics")
	}
	if len(usage) != 20 {
		t.Errorf("Expected 20 metrics used, got %d", len(usage))
	}
}
